<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoFo Music | Private Listening</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --gold: #c5a367;
            --soft: #f8f8f8;
            --muted: #777;
            --card-bg: rgba(255, 255, 255, 0.02);
            --heart: #ff4b2b;
            --ambient-color: rgba(197, 163, 103, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: #0a0a0a;
            background-image: radial-gradient(circle at 50% -20%, #222 0%, #0a0a0a 80%);
            color: var(--soft);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- AUTH SECTION --- */
        #authOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(50px);
        }

        .auth-card {
            width: 100%; max-width: 400px; padding: 40px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px; text-align: center;
        }

        .auth-card h2 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin-bottom: 10px; color: var(--gold); }
        .auth-card p { font-size: 12px; color: var(--muted); margin-bottom: 30px; letter-spacing: 1px; }

        .auth-form input {
            width: 100%; padding: 16px; margin-bottom: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: white; outline: none; transition: 0.3s;
        }
        .auth-form input:focus { border-color: var(--gold); background: rgba(255,255,255,0.08); }

        .auth-btn {
            width: 100%; padding: 16px; background: var(--gold); border: none;
            border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 2px;
        }

        .toggle-auth { font-size: 11px; color: var(--muted); margin-top: 20px; cursor: pointer; display: inline-block; }
        .toggle-auth b { color: var(--gold); }

        /* --- MAIN CONTENT --- */
        #mainContent { display: none; flex-direction: column; min-height: 100vh; }

        nav {
            display: flex; justify-content: center; gap: 40px; padding: 25px;
            background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(20px);
            position: sticky; top: 0; z-index: 2000; border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        nav span { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; cursor: pointer; color: var(--muted); transition: 0.4s; font-weight: 600; }
        nav span.active { color: var(--gold); }

        .hero { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 80px 20px; }
        h1 { font-family: 'Playfair Display', serif; font-size: clamp(4rem, 12vw, 8rem); background: linear-gradient(180deg, #fff 30%, rgba(255,255,255,0.2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sub { font-size: 11px; letter-spacing: .4em; text-transform: uppercase; color: var(--muted); margin-bottom: 60px; }

        .search-box { width: 100%; max-width: 550px; position: relative; z-index: 10; }
        .search-box input { width: 100%; padding: 24px; text-align: center; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.03); color: white; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .search-box button { width: 100%; padding: 20px; background: var(--gold); border: none; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 8px; }

        #results, #library { width: 100%; max-width: 800px; margin-top: 50px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 220px; }
        .track { padding: 12px; display: flex; align-items: center; gap: 20px; border-radius: 12px; background: var(--card-bg); cursor: pointer; transition: 0.3s; border: 1px solid transparent; }
        .track:hover { background: rgba(255,255,255,0.05); border-color: rgba(197, 163, 103, 0.2); transform: translateY(-2px); }
        .track img { width: 55px; height: 55px; border-radius: 6px; object-fit: cover; }

        .player-wrap { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 900px; z-index: 3000; }
        .ambient-glow { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--ambient-color); filter: blur(50px); border-radius: 30px; opacity: 0.6; z-index: -1; }
        .player { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(30px); padding: 20px 30px; display: flex; gap: 25px; align-items: center; border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.1); }
        #playerThumb { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
        #progress { -webkit-appearance: none; width: 100%; height: 3px; background: rgba(255,255,255,0.1); border-radius: 5px; outline: none; }
        .play-btn { background: #fff; color: #000; border: none; padding: 10px 25px; border-radius: 50px; font-weight: 800; font-size: 10px; cursor: pointer; }
        
        .hidden { display: none !important; }
        .invisible { opacity: 0; pointer-events: none; transform: translate(-50%, 20px); transition: 0.5s; }
        footer { padding: 80px 20px; background: #050505; text-align: center; border-top: 1px solid #111; }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-card" id="loginCard">
        <h2>VoFo</h2>
        <p>SECURE HIGH-FIDELITY ACCESS</p>
        <div class="auth-form">
            <input type="text" id="loginUser" placeholder="Username">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">Login</button>
        </div>
        <div class="toggle-auth" onclick="toggleAuth('register')">New to VoFo? <b>Register</b></div>
    </div>

    <div class="auth-card hidden" id="registerCard">
        <h2>Register</h2>
        <p>CREATE YOUR PRIVATE ACCOUNT</p>
        <div class="auth-form">
            <input type="text" id="regUser" placeholder="Username">
            <input type="password" id="regPass" placeholder="Password">
            <input type="password" id="regPassConfirm" placeholder="Re-enter Password">
            <button class="auth-btn" onclick="handleRegister()">Register</button>
        </div>
        <div class="toggle-auth" onclick="toggleAuth('login')">Already have an account? <b>Login</b></div>
    </div>
</div>

<div id="mainContent">
    <nav>
        <span id="navExplore" class="active" onclick="showTab('explore')">Explore</span>
        <span id="navLibrary" onclick="showTab('library')">Library</span>
        <span onclick="logout()" style="color:var(--heart); margin-left: 20px;">Logout</span>
    </nav>

    <div id="exploreTab" class="hero">
        <h1>VoFo</h1>
        <div class="sub">Purity in every frequency</div>
        <div class="search-box">
            <input id="searchInput" placeholder="Search artist or song..." autocomplete="off">
            <button onclick="doSearch()">Begin Exploration</button>
        </div>
        <div id="results"></div>
    </div>

    <div id="libraryTab" class="hero hidden">
        <h1>Library</h1>
        <div class="sub">Your private collection</div>
        <div id="library"></div>
    </div>

    <div class="player-wrap invisible" id="playerWrap">
        <div class="ambient-glow" id="glow"></div>
        <div class="player">
            <img id="playerThumb" src="" alt="">
            <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div id="trackTitle" style="font-weight:700; font-size:15px; color:#fff;"></div>
                        <div id="trackArtist" style="font-size:10px; color:var(--muted); text-transform:uppercase;"></div>
                    </div>
                    <canvas id="visualizer" width="120" height="30"></canvas>
                </div>
                <input type="range" id="progress" value="0" min="0" max="100" step="0.1">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button class="play-btn" id="playBtn" onclick="handlePlayPause()">PAUSE</button>
                    <div style="font-size:10px; color:var(--gold); font-family:monospace;" id="timeDisplay">0:00 / 0:00</div>
                    <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" style="width:60px;">
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div style="color:var(--gold); font-family:'Playfair Display'; font-size:2rem;">VoFo Music</div>
        <div style="font-size:10px; color:#333; margin-top:20px;">© 2026 VOFO MUSIC · BY ABHIRAM</div>
    </footer>
</div>

<script>
    const audio = new Audio();
    audio.crossOrigin = "anonymous";
    let hls = null, likedSongs = JSON.parse(localStorage.getItem('vofo_likes')) || [];

    // --- AUTH LOGIC ---
    function toggleAuth(type) {
        document.getElementById('loginCard').classList.toggle('hidden', type === 'register');
        document.getElementById('registerCard').classList.toggle('hidden', type === 'login');
    }

    function handleRegister() {
        const user = document.getElementById('regUser').value;
        const pass = document.getElementById('regPass').value;
        const pass2 = document.getElementById('regPassConfirm').value;

        if (!user || !pass) return alert("Please fill all fields");
        if (pass !== pass2) return alert("Passwords do not match");

        localStorage.setItem('vofo_user', JSON.stringify({user, pass}));
        alert("Registration Successful! Please Login.");
        toggleAuth('login');
    }

    function handleLogin() {
        const user = document.getElementById('loginUser').value;
        const pass = document.getElementById('loginPass').value;
        const saved = JSON.parse(localStorage.getItem('vofo_user'));

        if (saved && saved.user === user && saved.pass === pass) {
            enterApp();
        } else {
            alert("Invalid Credentials");
        }
    }

    function enterApp() {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('mainContent').style.display = 'flex';
    }

    function logout() {
        location.reload();
    }

    // Check session on load
    window.onload = () => {
        // Optional: Keep user logged in
        // if(localStorage.getItem('isLoggedIn')) enterApp();
    };

    // --- PLAYER & SEARCH LOGIC --- (Keep your existing functions)
    let audioCtx, analyser, dataArray, canvas, ctx;

    function initVisualizer() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        analyser.fftSize = 64;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        canvas = document.getElementById("visualizer");
        ctx = canvas.getContext("2d");
        draw();
    }

    function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let x = 0;
        for (let i = 0; i < dataArray.length; i++) {
            const barHeight = dataArray[i] / 8;
            ctx.fillStyle = `rgba(255, 255, 255, 0.5)`;
            ctx.fillRect(x, canvas.height - barHeight, 4, barHeight);
            x += 8;
        }
    }

    async function doSearch() {
        const q = document.getElementById("searchInput").value;
        if(!q) return;
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        renderTracks(data, "results");
    }

    function renderTracks(data, divId) {
        const container = document.getElementById(divId);
        container.innerHTML = "";
        data.forEach(song => {
            const div = document.createElement("div");
            div.className = "track";
            div.innerHTML = `<img src="${song.thumbnail}"><div><div>${song.title}</div><div style="color:var(--muted); font-size:10px;">${song.artist}</div></div>`;
            div.onclick = () => playSong(song);
            container.appendChild(div);
        });
    }

    async function playSong(song) {
        initVisualizer();
        document.getElementById("playerWrap").classList.remove("invisible");
        document.getElementById("trackTitle").innerText = song.title;
        document.getElementById("trackArtist").innerText = song.artist;
        document.getElementById("playerThumb").src = song.thumbnail;
        
        const res = await fetch("/api/play", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({url: song.id}) });
        const data = await res.json();
        
        if (hls) hls.destroy();
        if (Hls.isSupported() && data.stream_url.includes(".m3u8")) {
            hls = new Hls(); hls.loadSource(data.stream_url); hls.attachMedia(audio);
            hls.on(Hls.Events.MANIFEST_PARSED, () => audio.play());
        } else { audio.src = data.stream_url; audio.play(); }
    }

    function handlePlayPause() {
        if (audio.paused) audio.play(); else audio.pause();
    }

    function showTab(tab) {
        document.getElementById('exploreTab').classList.toggle('hidden', tab !== 'explore');
        document.getElementById('libraryTab').classList.toggle('hidden', tab !== 'library');
    }

    audio.ontimeupdate = () => {
        if (audio.duration) {
            document.getElementById("progress").value = (audio.currentTime / audio.duration) * 100;
            document.getElementById("timeDisplay").innerText = `${Math.floor(audio.currentTime/60)}:${Math.floor(audio.currentTime%60).toString().padStart(2,'0')} / ${Math.floor(audio.duration/60)}:${Math.floor(audio.duration%60).toString().padStart(2,'0')}`;
        }
    };
    document.getElementById("progress").oninput = () => audio.currentTime = (document.getElementById("progress").value / 100) * audio.duration;
    document.getElementById("volume").oninput = () => audio.volume = document.getElementById("volume").value;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoFo Music | Private Listening</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --bg: #0a0a0a; --gold: #c5a367; --soft: #f8f8f8; --muted: #777; --card-bg: rgba(255, 255, 255, 0.02); --heart: #ff4b2b; --ambient-color: rgba(197, 163, 103, 0.15); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #0a0a0a; background-image: radial-gradient(circle at 50% -20%, #222 0%, #0a0a0a 80%); color: var(--soft); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(50px); }
        .auth-card { width: 100%; max-width: 400px; padding: 40px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 24px; text-align: center; }
        .auth-card h2 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin-bottom: 10px; color: var(--gold); }
        .auth-form input { width: 100%; padding: 16px; margin-bottom: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; outline: none; }
        .auth-btn { width: 100%; padding: 16px; background: var(--gold); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        #mainContent { display: none; flex-direction: column; min-height: 100vh; }
        nav { display: flex; justify-content: center; gap: 40px; padding: 25px; background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 2000; border-bottom: 1px solid rgba(255,255,255,0.03); }
        nav span { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; cursor: pointer; color: var(--muted); font-weight: 600; }
        nav span.active { color: var(--gold); }
        .hero { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 80px 20px; }
        h1 { font-family: 'Playfair Display', serif; font-size: clamp(4rem, 12vw, 8rem); background: linear-gradient(180deg, #fff 30%, rgba(255,255,255,0.2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .search-box { width: 100%; max-width: 550px; }
        .search-box input { width: 100%; padding: 24px; text-align: center; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.03); color: white; margin-bottom: 20px; }
        .search-box button { width: 100%; padding: 20px; background: var(--gold); border: none; font-weight: 700; cursor: pointer; border-radius: 8px; }
        #results { width: 100%; max-width: 800px; margin-top: 50px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 220px; }
        .track { padding: 12px; display: flex; align-items: center; gap: 20px; border-radius: 12px; background: var(--card-bg); cursor: pointer; }
        .track img { width: 55px; height: 55px; border-radius: 6px; }
        .player-wrap { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 900px; z-index: 3000; }
        .player { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(30px); padding: 20px 30px; display: flex; gap: 25px; align-items: center; border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .hidden { display: none !important; }
        .invisible { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-card" id="loginCard">
        <h2>VoFo</h2><p>SECURE ACCESS</p>
        <div class="auth-form">
            <input type="text" id="loginUser" placeholder="Username">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">Login</button>
        </div>
        <div onclick="toggleAuth('register')" style="cursor:pointer; margin-top:20px; font-size:12px;">New? <b>Register</b></div>
    </div>
    <div class="auth-card hidden" id="registerCard">
        <h2>Register</h2><p>CREATE ACCOUNT</p>
        <div class="auth-form">
            <input type="text" id="regUser" placeholder="Username">
            <input type="password" id="regPass" placeholder="Password">
            <input type="password" id="regPassConfirm" placeholder="Confirm Password">
            <button class="auth-btn" onclick="handleRegister()">Register</button>
        </div>
        <div onclick="toggleAuth('login')" style="cursor:pointer; margin-top:20px; font-size:12px;">Back to <b>Login</b></div>
    </div>
</div>

<div id="mainContent">
    <nav>
        <span class="active">Explore</span>
        <span onclick="logout()" style="color:var(--heart); margin-left:20px;">Logout</span>
    </nav>
    <div class="hero">
        <h1>VoFo</h1>
        <div class="search-box">
            <input id="searchInput" placeholder="Search artist or song...">
            <button onclick="doSearch()">Explore</button>
        </div>
        <div id="results"></div>
    </div>
    <div class="player-wrap invisible" id="playerWrap">
        <div class="player">
            <img id="playerThumb" src="" style="width:60px;height:60px;border-radius:10px;">
            <div style="flex:1">
                <div id="trackTitle" style="font-weight:700;"></div>
                <div id="trackArtist" style="font-size:10px; color:var(--muted);"></div>
                <input type="range" id="progress" style="width:100%; margin-top:10px;">
                <button onclick="handlePlayPause()" id="playBtn" style="margin-top:10px; padding:5px 15px; border-radius:20px; border:none; cursor:pointer;">PAUSE</button>
            </div>
        </div>
    </div>
</div>

<script>
    const audio = new Audio();
    audio.crossOrigin = "anonymous";
    let hls = null;

    function toggleAuth(type) {
        document.getElementById('loginCard').classList.toggle('hidden', type === 'register');
        document.getElementById('registerCard').classList.toggle('hidden', type === 'login');
    }

    async function handleRegister() {
        const username = document.getElementById('regUser').value;
        const password = document.getElementById('regPass').value;
        const confirm = document.getElementById('regPassConfirm').value;
        if(password !== confirm) return alert("Passwords mismatch");

        const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        if(res.ok) { alert("Success! Please Login"); toggleAuth('login'); }
        else alert("Registration failed");
    }

    async function handleLogin() {
        const username = document.getElementById('loginUser').value;
        const password = document.getElementById('loginPass').value;
        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        if(res.ok) enterApp();
        else alert("Invalid Credentials");
    }

    function enterApp() {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('mainContent').style.display = 'flex';
    }

    async function logout() {
        await fetch('/api/auth/logout');
        location.reload();
    }

    async function doSearch() {
        const q = document.getElementById("searchInput").value;
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        if(res.status === 401) return alert("Please Login First");
        const data = await res.json();
        const container = document.getElementById("results");
        container.innerHTML = "";
        data.forEach(song => {
            const div = document.createElement("div");
            div.className = "track";
            div.innerHTML = `<img src="${song.thumbnail}"><div>${song.title}</div>`;
            div.onclick = () => playSong(song);
            container.appendChild(div);
        });
    }

    async function playSong(song) {
        document.getElementById("playerWrap").classList.remove("invisible");
        document.getElementById("trackTitle").innerText = song.title;
        document.getElementById("trackArtist").innerText = song.artist;
        document.getElementById("playerThumb").src = song.thumbnail;
        const res = await fetch("/api/play", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({url: song.id})
        });
        const data = await res.json();
        if (hls) hls.destroy();
        if (Hls.isSupported() && data.stream_url.includes(".m3u8")) {
            hls = new Hls(); hls.loadSource(data.stream_url); hls.attachMedia(audio);
            hls.on(Hls.Events.MANIFEST_PARSED, () => audio.play());
        } else { audio.src = data.stream_url; audio.play(); }
    }

    function handlePlayPause() {
        if (audio.paused) { audio.play(); document.getElementById("playBtn").innerText="PAUSE"; }
        else { audio.pause(); document.getElementById("playBtn").innerText="PLAY"; }
    }

    // Check if already logged in on refresh
    window.onload = async () => {
        const res = await fetch('/api/auth/status');
        const data = await res.json();
        if(data.logged_in) enterApp();
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoFo Music</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
    :root{ --bg:#050505; --gold:#c5a367; --muted:#777; --card:rgba(255,255,255,0.03); }
    body{ background:var(--bg); color:white; font-family:'Inter', sans-serif; margin:0; overflow:hidden; }
    .hidden{ display:none !important; }
    
    /* Auth */
    .auth-box{ position:fixed; inset:0; background:var(--bg); z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .card{ background:#111; padding:30px; border-radius:12px; border:1px solid #222; width:300px; text-align:center; }
    input{ width:100%; padding:12px; margin-bottom:10px; background:#000; border:1px solid #333; color:white; border-radius:4px; box-sizing:border-box; }
    .btn{ width:100%; padding:12px; background:var(--gold); border:none; border-radius:4px; cursor:pointer; font-weight:bold; }

    /* App */
    .app-wrap{ display:grid; grid-template-columns:240px 1fr; height:100vh; }
    .side{ background:#000; padding:30px; border-right:1px solid #222; }
    .nav-link{ padding:10px; color:var(--muted); cursor:pointer; margin-bottom:10px; }
    .nav-link.active{ color:var(--gold); font-weight:bold; }
    
    .content{ padding:40px; overflow-y:auto; padding-bottom:120px; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:20px; }
    .song-item{ background:var(--card); padding:10px; border-radius:8px; cursor:pointer; text-align:center; }
    .song-item img{ width:100%; aspect-ratio:1; border-radius:4px; object-fit:cover; }

    /* Player */
    .player{ position:fixed; bottom:0; width:100%; background:rgba(10,10,10,0.95); padding:15px 30px; display:flex; align-items:center; gap:20px; border-top:1px solid #222; box-sizing:border-box; }
    #prog{ flex:1; accent-color:var(--gold); }
</style>
</head>
<body>

<div id="authContainer" class="auth-box">
    <h1 style="font-family:'Playfair Display'; color:var(--gold);">VoFo</h1>
    <div id="regView" class="card">
        <input id="rU" placeholder="Username">
        <input id="rP" type="password" placeholder="Password">
        <button class="btn" onclick="handleAuth('register')">CREATE ACCOUNT</button>
        <p style="font-size:12px; cursor:pointer" onclick="toggleV('log')">Login instead</p>
    </div>
    <div id="logView" class="card hidden">
        <input id="lU" placeholder="Username">
        <input id="lP" type="password" placeholder="Password">
        <button class="btn" onclick="handleAuth('login')">LOGIN</button>
        <p style="font-size:12px; cursor:pointer" onclick="toggleV('reg')">Register instead</p>
    </div>
</div>

<div id="mainApp" class="app-wrap hidden">
    <div class="side">
        <h2 style="color:var(--gold)">VoFo</h2>
        <div class="nav-link active" onclick="setView('search')">EXPLORE</div>
        <div class="nav-link" onclick="setView('liked')">LIKED</div>
        <a href="/api/logout" style="color:#444; font-size:12px; text-decoration:none">LOGOUT</a>
    </div>
    <div class="content">
        <div id="searchSection">
            <div style="display:flex; gap:10px; margin-bottom:30px;">
                <input id="sq" placeholder="Search tracks..." style="margin:0">
                <button onclick="doSearch()" class="btn" style="width:auto">SEARCH</button>
            </div>
            <div id="results" class="grid"></div>
        </div>
        <div id="likedSection" class="hidden">
            <h2>Your Likes</h2>
            <div id="likedGrid" class="grid"></div>
        </div>
    </div>
</div>

<div id="playerBar" class="player hidden">
    <img id="pImg" src="" style="width:50px; height:50px">
    <div style="flex:1">
        <div id="pTitle" style="font-size:12px; font-weight:bold"></div>
        <input type="range" id="prog" value="0">
    </div>
    <span id="lBtn" onclick="doLike()" style="cursor:pointer; font-size:20px">♡</span>
    <button id="playBtn" onclick="toggleP()" class="btn" style="width:auto">PAUSE</button>
</div>

<script>
    const audio = new Audio();
    let current = null;

    // View Switching
    function toggleV(m){
        regView.classList.toggle('hidden', m==='log');
        logView.classList.toggle('hidden', m==='reg');
    }

    function setView(v){
        searchSection.classList.toggle('hidden', v!=='search');
        likedSection.classList.toggle('hidden', v!=='liked');
        if(v==='liked') loadLikes();
    }

    // Auth
    async function handleAuth(type){
        const u = type==='register' ? rU.value : lU.value;
        const p = type==='register' ? rP.value : lP.value;
        const res = await fetch(`/api/${type}`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username:u, password:p})
        });
        const data = await res.json();
        if(data.success){
            if(type==='register') toggleV('log');
            else location.reload();
        } else alert(data.error);
    }

    // Load App if Logged In
    fetch('/api/auth/status').then(r=>r.json()).then(d=>{
        if(d.logged_in){
            authContainer.classList.add('hidden');
            mainApp.classList.remove('hidden');
        }
    });

    // Music
    async function doSearch(){
        const res = await fetch(`/api/search?q=${encodeURIComponent(sq.value)}`);
        const data = await res.json();
        results.innerHTML = data.map(s => `
            <div class="song-item" onclick='play(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                <img src="${s.thumbnail || ''}">
                <div style="font-size:12px; margin-top:5px">${s.title}</div>
            </div>
        `).join('');
    }

    async function play(s){
        current = s;
        playerBar.classList.remove('hidden');
        pImg.src = s.thumbnail; pTitle.innerText = s.title;
        const res = await fetch('/api/play', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({url:s.id})
        });
        const d = await res.json();
        audio.src = d.stream_url; audio.play();
        playBtn.innerText = "PAUSE";
    }

    async function doLike(){
        const res = await fetch('/api/like', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(current)
        });
        const d = await res.json();
        lBtn.innerText = d.status === 'liked' ? '♥' : '♡';
    }

    async function loadLikes(){
        const res = await fetch('/api/library');
        const data = await res.json();
        likedGrid.innerHTML = data.map(s => `
            <div class="song-item" onclick='play(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                <img src="${s.thumbnail || ''}">
                <div style="font-size:12px">${s.title}</div>
            </div>
        `).join('');
    }

    function toggleP(){
        if(audio.paused){ audio.play(); playBtn.innerText="PAUSE"; }
        else { audio.pause(); playBtn.innerText="PLAY"; }
    }

    audio.ontimeupdate = () => { if(audio.duration) prog.value = (audio.currentTime/audio.duration)*100; };
    prog.oninput = () => { audio.currentTime = (prog.value/100)*audio.duration; };
</script>
</body>
</html>
